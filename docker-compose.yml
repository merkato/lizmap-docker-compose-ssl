services:

  # --- NOWA SEKCJA: Nginx Proxy Manager ---
  npm:
    image: 'jc21/nginx-proxy-manager:latest'
    container_name: nginx-proxy-manager
    restart: unless-stopped
    ports:
      - '80:80'     # Publiczny HTTP
      - '443:443'   # Publiczny HTTPS
      - '81:81'     # Panel Administracyjny
    environment:
      DB_SQLITE_FILE: "/data/database.sqlite"
    volumes:
      - ./npm-data:/data
      - ./npm-letsencrypt:/etc/letsencrypt
    depends_on:
      - web
    networks:
      - lizmap-net

  # --- ORYGINALNE USŁUGI 3LIZ (Zmodyfikowane) ---
  lizmap:
    image: 3liz/lizmap-web-client:${LIZMAP_VERSION_TAG:-3.8}
    restart: unless-stopped
    environment:
      LIZMAP_CACHEMODE: "${LIZMAP_CACHEMODE:-sqlite}"
      LIZMAP_DB_HOST: "${LIZMAP_DB_HOST:-postgis}"
      LIZMAP_DB_PORT: "${LIZMAP_DB_PORT:-5432}"
      LIZMAP_DB_USER: "${LIZMAP_DB_USER:-postgres}"
      LIZMAP_DB_PASSWORD: "${LIZMAP_DB_PASSWORD:-postgres}"
      LIZMAP_DB_NAME: "${LIZMAP_DB_NAME:-postgres}"
      LIZMAP_WMSSERVER_URL: "${LIZMAP_WMSSERVER_URL:-http://lizmap:8080/ows/}"
    volumes:
      - ${LIZMAP_DIR}/instances:/var/www/lizmap-web-client/lizmap/var/instances
      - ${LIZMAP_DIR}/var:/var/www/lizmap-web-client/lizmap/var
      - ${LIZMAP_DIR}/www:/var/www/lizmap-web-client/lizmap/www
    depends_on:
      - postgis
      - wps
    networks:
      - lizmap-net

  web:
    image: nginx:alpine
    restart: unless-stopped
    # ZMIANA: expose zamiast ports. Ukrywamy port 80 przed światem, widzi go tylko NPM.
    expose:
      - 80
    volumes:
      - ${LIZMAP_DIR}/instances:/var/www/lizmap-web-client/lizmap/var/instances
      - ${LIZMAP_DIR}/www:/var/www/lizmap-web-client/lizmap/www
      # Mapowanie konfiguracji z repozytorium
      - ./etc/nginx.conf:/etc/nginx/conf.d/default.conf
    depends_on:
      - lizmap
    networks:
      - lizmap-net

  postgis:
    image: 3liz/postgis:${POSTGIS_VERSION_TAG:-17-3}
    restart: unless-stopped
    volumes:
      - postgis-data:/var/lib/postgresql/data
    environment:
      POSTGRES_PASSWORD: "${LIZMAP_DB_PASSWORD:-postgres}"
      POSTGRES_USER: "${LIZMAP_DB_USER:-postgres}"
      POSTGRES_DB: "${LIZMAP_DB_NAME:-postgres}"
    # ZMIANA: Usunięto sekcję ports całkowicie (Baza tylko wewnętrzna)
    networks:
      - lizmap-net

  qgis-server:
    image: 3liz/qgis-map-server:${QGIS_VERSION_TAG:-3.34}
    restart: unless-stopped
    environment:
      QGSRV_SERVER_WORKERS: "${QGSRV_SERVER_WORKERS:-1}"
      QGSRV_CACHE_SIZE: "${QGSRV_CACHE_SIZE:-20}"
      QGSRV_LOGGING_LEVEL: "${QGSRV_LOGGING_LEVEL:-DEEP}"
      QGSRV_USER: "${LIZMAP_USER_ID:-1000}:${LIZMAP_GROUP_ID:-1000}"
    volumes:
      - ${LIZMAP_DIR}/instances:/srv/projects
      - ${LIZMAP_DIR}/wps-data:/srv/data
    networks:
      - lizmap-net

  wps:
    image: 3liz/qgis-wps:${QGIS_VERSION_TAG:-3.34}
    restart: unless-stopped
    environment:
      QGSRV_SERVER_WORKERS: "${QGSRV_SERVER_WORKERS:-1}"
      QGIS_PROJECT_FILE: "/srv/data/wps.qgs"
    volumes:
      - ${LIZMAP_DIR}/wps-data:/srv/data
    networks:
      - lizmap-net

volumes:
  postgis-data:
    driver: local

networks:
  lizmap-net:
    driver: bridge
