services:
  # --- 1. Nginx Proxy Manager (SSL/HTTPS Gateway) ---
  npm:
    image: 'jc21/nginx-proxy-manager:latest'
    container_name: nginx-proxy-manager
    restart: unless-stopped
    ports:
      - '80:80'
      - '443:443'
      - '81:81'
    environment:
      DB_SQLITE_FILE: "/data/database.sqlite"
    volumes:
      - ./npm-data:/data
      - ./npm-letsencrypt:/etc/letsencrypt
    depends_on:
      - web
    networks:
      - lizmap-net

  # --- 2. INIT CONTAINER (Automatyczna naprawa struktury) ---
  # Uruchamia się raz przed startem Lizmapa.
  # Kopiuje pliki z obrazu na dysk hosta, jeśli katalogi są puste.
  # Konfiguruje HTTPS w plikach PHP.
  lizmap-init:
    image: 3liz/lizmap-web-client:${LIZMAP_VERSION_TAG:-3.8}
    user: root
    volumes:
      # Montujemy katalog hosta (LIZMAP_DIR) do tymczasowego folderu /host w kontenerze
      - ${LIZMAP_DIR}/lizmap:/host/lizmap
    entrypoint: >
      sh -c "
      echo '--- START INITIALIZATION ---';
      
      # Funkcja kopiująca, jeśli folder docelowy jest pusty
      init_dir() {
        SRC=\$1
        DEST=\$2
        if [ -z \"\$(ls -A \$DEST 2>/dev/null)\" ]; then
          echo \"Inicjalizacja \$DEST...\"
          mkdir -p \$DEST
          cp -Rn \$SRC/* \$DEST/
        else
          echo \"\$DEST nie jest pusty, pomijam kopiowanie.\"
        fi
      }

      # 1. Kopiuj strukturę
      # Ścieżka źródłowa w obrazie 3.8 to /var/www/lizmap-web-client/lizmap
      init_dir /var/www/lizmap-web-client/lizmap/var /host/lizmap/var
      init_dir /var/www/lizmap-web-client/lizmap/www /host/lizmap/www
      
      # Upewnij się, że folder instances istnieje
      mkdir -p /host/lizmap/instances

      # 2. Konfiguracja HTTPS (edycja pliku localconfig)
      CONFIG_FILE=/host/lizmap/var/config/localconfig.ini.php
      DIST_FILE=/host/lizmap/var/config/localconfig.ini.php.dist
      
      if [ ! -f \$CONFIG_FILE ] && [ -f \$DIST_FILE ]; then
         echo 'Tworzenie localconfig.ini.php...'
         cp \$DIST_FILE \$CONFIG_FILE
      fi

      if [ -f \$CONFIG_FILE ]; then
         echo 'Wymuszanie HTTPS w konfiguracji...'
         # Usuń stary wpis jeśli istnieje i dodaj nowy
         sed -i '/isHttps/d' \$CONFIG_FILE
         sed -i '/\[main\]/a isHttps = 1' \$CONFIG_FILE
      fi

      # 3. Naprawa uprawnień (UID 33 = www-data, UID 1000 = typowy user)
      echo 'Naprawa uprawnień...'
      chown -R 33:33 /host/lizmap
      chmod -R 775 /host/lizmap
      
      echo '--- INIT COMPLETE ---'
      "

  # --- 3. Lizmap Web Client ---
  lizmap:
    image: 3liz/lizmap-web-client:${LIZMAP_VERSION_TAG:-3.8}
    restart: unless-stopped
    environment:
      LIZMAP_CACHEMODE: "${LIZMAP_CACHEMODE}"
      LIZMAP_DB_HOST: "${LIZMAP_DB_HOST}"
      LIZMAP_DB_PORT: "${LIZMAP_DB_PORT}"
      LIZMAP_DB_USER: "${LIZMAP_DB_USER}"
      LIZMAP_DB_PASSWORD: "${LIZMAP_DB_PASSWORD}"
      LIZMAP_DB_NAME: "${LIZMAP_DB_NAME}"
    volumes:
      # Mapujemy katalogi hosta, które init-container przed chwilą wypełnił
      - ${LIZMAP_DIR}/lizmap/instances:/var/www/lizmap-web-client/lizmap/instances
      - ${LIZMAP_DIR}/lizmap/var:/var/www/lizmap-web-client/lizmap/var
      - ${LIZMAP_DIR}/lizmap/www:/var/www/lizmap-web-client/lizmap/www
    depends_on:
      lizmap-init:
        condition: service_completed_successfully
      postgis:
        condition: service_started
      wps:
        condition: service_started
    networks:
      - lizmap-net

  # --- 4. Nginx (Internal Web Server) ---
  web:
    image: nginx:alpine
    restart: unless-stopped
    expose:
      - 80
    volumes:
      # Nginx musi widzieć pliki statyczne
      - ${LIZMAP_DIR}/lizmap/www:/var/www/lizmap-web-client/lizmap/www
      # Montujemy plik nginx.conf z głównego katalogu repozytorium
      - ./nginx.conf:/etc/nginx/conf.d/default.conf
    depends_on:
      - lizmap
    networks:
      - lizmap-net

  # --- 5. Database & GIS Services ---
  postgis:
    image: 3liz/postgis:${POSTGIS_VERSION_TAG:-15-3.3}
    restart: unless-stopped
    volumes:
      - postgis-data:/var/lib/postgresql/data
    environment:
      POSTGRES_PASSWORD: "${LIZMAP_DB_PASSWORD}"
      POSTGRES_USER: "${LIZMAP_DB_USER}"
      POSTGRES_DB: "${LIZMAP_DB_NAME}"
    networks:
      - lizmap-net

  qgis-server:
    image: 3liz/qgis-map-server:${QGIS_VERSION_TAG:-3.22}
    restart: unless-stopped
    environment:
      QGSRV_SERVER_WORKERS: 1
      QGSRV_USER: "${LIZMAP_USER_ID}:${LIZMAP_GROUP_ID}"
    volumes:
      - ${LIZMAP_DIR}/lizmap/instances:/srv/projects
      - ${LIZMAP_DIR}/wps-data:/srv/data
    networks:
      - lizmap-net

  wps:
    image: 3liz/qgis-wps:${QGIS_VERSION_TAG:-3.22}
    restart: unless-stopped
    environment:
      QGIS_PROJECT_FILE: "/srv/data/wps.qgs"
    volumes:
      - ${LIZMAP_DIR}/wps-data:/srv/data
    networks:
      - lizmap-net

volumes:
  postgis-data:
    driver: local

networks:
  lizmap-net:
    driver: bridge
