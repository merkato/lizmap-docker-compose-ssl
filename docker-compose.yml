services:
  # --- 1. Proxy SSL (Nginx Proxy Manager) ---
  npm:
    image: 'jc21/nginx-proxy-manager:latest'
    container_name: nginx-proxy-manager
    restart: unless-stopped
    ports:
      - '80:80'
      - '443:443'
      - '81:81'
    environment:
      DB_SQLITE_FILE: "/data/database.sqlite"
    volumes:
      - ./npm-data:/data
      - ./npm-letsencrypt:/etc/letsencrypt
    depends_on:
      - web
    networks:
      - lizmap-net

  # --- 2. INIT CONTAINER (Rozwiązanie Twojego problemu) ---
  # Ten kontener uruchamia się raz, kopiuje pliki, ustawia uprawnienia i HTTPS, po czym znika.
  lizmap-init:
    image: 3liz/lizmap-web-client:${LIZMAP_VERSION_TAG:-3.8}
    user: root
    volumes:
      - ./lizmap/var:/target/var
      - ./lizmap/www:/target/www
    entrypoint: >
      sh -c "
      echo 'Inicjalizacja plików Lizmap...';
      
      # 1. Jeśli folder var na hoście jest pusty, skopiuj oryginalne pliki z obrazu
      if [ -z \"$(ls -A /target/var)\" ]; then
        echo 'Kopiowanie domyślnej konfiguracji...';
        cp -Rn /var/www/lizmap-web-client/lizmap/var/* /target/var/;
      fi
      
      # 2. Jeśli folder www na hoście jest pusty, skopiuj aplikację
      if [ -z \"$(ls -A /target/www)\" ]; then
        echo 'Kopiowanie plików aplikacji...';
        cp -Rn /var/www/lizmap-web-client/lizmap/www/* /target/www/;
      fi

      # 3. WYMUSZENIE HTTPS (Automatyczna edycja configu)
      if [ -f /target/var/config/localconfig.ini.php ]; then
         echo 'Konfiguracja HTTPS...';
         sed -i '/isHttps/d' /target/var/config/localconfig.ini.php;
         sed -i '/\[main\]/a isHttps = 1' /target/var/config/localconfig.ini.php;
      elif [ -f /target/var/config/localconfig.ini.php.dist ]; then
         # Jeśli config nie istnieje, stwórz go z dist i dodaj HTTPS
         cp /target/var/config/localconfig.ini.php.dist /target/var/config/localconfig.ini.php;
         sed -i '/\[main\]/a isHttps = 1' /target/var/config/localconfig.ini.php;
      fi

      # 4. Naprawa uprawnień (UID 33 to www-data w tym obrazie)
      echo 'Naprawa uprawnień...';
      chown -R 33:33 /target/var;
      chmod -R 775 /target/var;
      
      echo 'Inicjalizacja zakończona.';
      "

  # --- 3. Właściwy Lizmap ---
  lizmap:
    image: 3liz/lizmap-web-client:${LIZMAP_VERSION_TAG:-3.8}
    restart: unless-stopped
    environment:
      LIZMAP_CACHEMODE: "sqlite"
      LIZMAP_DB_HOST: "postgis"
      LIZMAP_DB_USER: "${LIZMAP_DB_USER}"
      LIZMAP_DB_PASSWORD: "${LIZMAP_DB_PASSWORD}"
      LIZMAP_DB_NAME: "${LIZMAP_DB_NAME}"
    volumes:
      - ./lizmap/instances:/var/www/lizmap-web-client/lizmap/instances
      - ./lizmap/var:/var/www/lizmap-web-client/lizmap/var
      - ./lizmap/www:/var/www/lizmap-web-client/lizmap/www
    depends_on:
      lizmap-init:
        condition: service_completed_successfully
      postgis:
        condition: service_started
      wps:
        condition: service_started
    networks:
      - lizmap-net

  # --- 4. Nginx (Web Server) ---
  web:
    image: nginx:alpine
    restart: unless-stopped
    expose:
      - 80
    volumes:
      # Mapujemy kod aplikacji, aby Nginx mógł serwować pliki statyczne (JS, CSS)
      - ./lizmap/www:/var/www/lizmap-web-client/lizmap/www
      # Nasz plik konfiguracyjny
      - ./etc/nginx/conf.d/lizmap.conf:/etc/nginx/conf.d/default.conf
    depends_on:
      - lizmap
    networks:
      - lizmap-net

  # --- 5. Baza Danych i QGIS ---
  postgis:
    image: 3liz/postgis:${POSTGIS_VERSION_TAG:-15-3.3}
    restart: unless-stopped
    volumes:
      - postgis-data:/var/lib/postgresql/data
    environment:
      POSTGRES_PASSWORD: "${LIZMAP_DB_PASSWORD}"
      POSTGRES_USER: "${LIZMAP_DB_USER}"
      POSTGRES_DB: "${LIZMAP_DB_NAME}"
    networks:
      - lizmap-net

  qgis-server:
    image: 3liz/qgis-map-server:${QGIS_VERSION_TAG:-3.22}
    restart: unless-stopped
    environment:
      QGSRV_SERVER_WORKERS: 1
    volumes:
      - ./lizmap/instances:/srv/projects
      - ./wps-data:/srv/data
    networks:
      - lizmap-net

  wps:
    image: 3liz/qgis-wps:${QGIS_VERSION_TAG:-3.22}
    restart: unless-stopped
    environment:
      QGIS_PROJECT_FILE: "/srv/data/wps.qgs"
    volumes:
      - ./wps-data:/srv/data
    networks:
      - lizmap-net

volumes:
  postgis-data:
    driver: local

networks:
  lizmap-net:
    driver: bridge
